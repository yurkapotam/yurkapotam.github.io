<!DOCTYPE html>
<html>
    <head>
        <title>ExtRTS</title>
        <style>
            html
            {
                height: 100%;
                width: 100%;
            }
            
            body
            {
                margin: 0px;
                height: 100%;
                width: 100%;
                display: flex;
            }

            #world
            {
                overflow: scroll;
                height: 100%;
                width: 70%;
                background-color: black;
                white-space: nowrap;
                flex: 4;
            }

            .row
            {
                display: block;
            }

            #sidebar
            {
                height: 100%;
                width: 30%;
                flex: 1;
            }

            .sidebyside
            {
                display: flex;
            }

            .sidebyside *
            {
                flex: 1;
            }
            
            .tile
            {
                height: 100px;
                width: 100px;
                display: inline-block;
            }

            .cash
            {
                text-align: center;
            }

            #sidebar-flag
            {
                object-fit: fill;
            }
        </style>
    </head>
    <body>
        <a id="loading">Loading...</a>
        <div id="world" style="display: none;"></div>
        <div id="sidebar" style="display: none;">
            <div class="cash">0</div>
            <img id="sidebar-flag">
            <div class="sidebyside">
                <button id="repair" onclick="repair();">Repair</button>
                <button id="sell" onclick="sell();">Sell</button>
            </div>
            <div class="sidebyside">
                <button id="buildingsbutton" onclick="buildcat();">(Buildings)</button>
                <button id="defbuildingsbutton" onclick="defensecat();">Defense</button>
                <button id="infantrybutton" onclick="infantrycat();">Infantry</button>
                <button id="vehiclesbutton" onclick="vehiclecat();">Vehicles</button>
            </div>
            <div id="buildings">
                <div class="sidebyside">
                    <button onclick="buildrequest(0);">???</button>
                    <button onclick="buildrequest(1);">???</button>
                    <button onclick="buildrequest(2);">???</button>
                    <button onclick="buildrequest(3);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="buildrequest(4);">???</button>
                    <button onclick="buildrequest(5);">???</button>
                    <button onclick="buildrequest(6);">???</button>
                    <button onclick="buildrequest(7);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="buildrequest(8);">???</button>
                    <button onclick="buildrequest(9);">???</button>
                    <button onclick="buildrequest(10);">???</button>
                    <button onclick="buildrequest(11);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="buildrequest(12);">???</button>
                    <button onclick="buildrequest(13);">???</button>
                    <button onclick="buildrequest(14);">???</button>
                    <button onclick="buildrequest(15);">???</button>
                </div>
            </div>
            <div id="defbuildings" style="display: none;">
                <div class="sidebyside">
                    <button onclick="defrequest(0);">???</button>
                    <button onclick="defrequest(1);">???</button>
                    <button onclick="defrequest(2);">???</button>
                    <button onclick="defrequest(3);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="defrequest(4);">???</button>
                    <button onclick="defrequest(5);">???</button>
                    <button onclick="defrequest(6);">???</button>
                    <button onclick="defrequest(7);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="defrequest(8);">???</button>
                    <button onclick="defrequest(9);">???</button>
                    <button onclick="defrequest(10);">???</button>
                    <button onclick="defrequest(11);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="defrequest(12);">???</button>
                    <button onclick="defrequest(13);">???</button>
                    <button onclick="defrequest(14);">???</button>
                    <button onclick="defrequest(15);">???</button>
                </div>
            </div>
            <div id="infantry" style="display: none;">
                <div class="sidebyside">
                    <button onclick="infrequest(0);">???</button>
                    <button onclick="infrequest(1);">???</button>
                    <button onclick="infrequest(2);">???</button>
                    <button onclick="infrequest(3);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="infrequest(4);">???</button>
                    <button onclick="infrequest(5);">???</button>
                    <button onclick="infrequest(6);">???</button>
                    <button onclick="infrequest(7);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="infrequest(8);">???</button>
                    <button onclick="infrequest(9);">???</button>
                    <button onclick="infrequest(10);">???</button>
                    <button onclick="infrequest(11);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="infrequest(12);">???</button>
                    <button onclick="infrequest(13);">???</button>
                    <button onclick="infrequest(14);">???</button>
                    <button onclick="infrequest(15);">???</button>
                </div>
            </div>
            <div id="vehicles" style="display: none;">
                <div class="sidebyside">
                    <button onclick="vehrequest(0);">???</button>
                    <button onclick="vehrequest(1);">???</button>
                    <button onclick="vehrequest(2);">???</button>
                    <button onclick="vehrequest(3);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="vehrequest(4);">???</button>
                    <button onclick="vehrequest(5);">???</button>
                    <button onclick="vehrequest(6);">???</button>
                    <button onclick="vehrequest(7);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="vehrequest(8);">???</button>
                    <button onclick="vehrequest(9);">???</button>
                    <button onclick="vehrequest(10);">???</button>
                    <button onclick="vehrequest(11);">???</button>
                </div>
                <div class="sidebyside">
                    <button onclick="vehrequest(12);">???</button>
                    <button onclick="vehrequest(13);">???</button>
                    <button onclick="vehrequest(14);">???</button>
                    <button onclick="vehrequest(15);">???</button>
                </div>
            </div>
        </div>
        <script>
            var repairing = false;
            var selling = false;

            var buildings = [];
            var units = [];
            var players = [];
            var category = "buildings"

            function buildcat()
            {
                category = "buildings";
                document.getElementById("infantry").style.display = "none";
                document.getElementById("vehicles").style.display = "none";
                document.getElementById("buildings").style.display = "block";
                document.getElementById("defbuildings").style.display = "none";
                document.getElementById("buildingsbutton").innerHTML = "(Buildings)";
                document.getElementById("defbuildingsbutton").innerHTML = "Defense";
                document.getElementById("infantrybutton").innerHTML = "Infantry";
                document.getElementById("vehiclesbutton").innerHTML = "Vehicles";
            }

            function defensecat()
            {
                category = "defbuildings";
                document.getElementById("infantry").style.display = "none";
                document.getElementById("vehicles").style.display = "none";
                document.getElementById("buildings").style.display = "none";
                document.getElementById("defbuildings").style.display = "block";
                document.getElementById("buildingsbutton").innerHTML = "Buildings";
                document.getElementById("defbuildingsbutton").innerHTML = "(Defense)";
                document.getElementById("infantrybutton").innerHTML = "Infantry";
                document.getElementById("vehiclesbutton").innerHTML = "Vehicles";
            }

            function infantrycat()
            {
                category = "infantry";
                document.getElementById("infantry").style.display = "block";
                document.getElementById("vehicles").style.display = "none";
                document.getElementById("buildings").style.display = "none";
                document.getElementById("defbuildings").style.display = "none";
                document.getElementById("buildingsbutton").innerHTML = "Buildings";
                document.getElementById("defbuildingsbutton").innerHTML = "Defense";
                document.getElementById("infantrybutton").innerHTML = "(Infantry)";
                document.getElementById("vehiclesbutton").innerHTML = "Vehicles";
            }

            function vehiclecat()
            {
                category = "vehicles";
                document.getElementById("infantry").style.display = "none";
                document.getElementById("vehicles").style.display = "block";
                document.getElementById("buildings").style.display = "none";
                document.getElementById("defbuildings").style.display = "none";
                document.getElementById("buildingsbutton").innerHTML = "Buildings";
                document.getElementById("defbuildingsbutton").innerHTML = "Defense";
                document.getElementById("infantrybutton").innerHTML = "Infantry";
                document.getElementById("vehiclesbutton").innerHTML = "(Vehicles)";
            }
            
            // https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
            function getqueryparam(name, url = window.location.href)
            {
                name = name.replace(/[\[\]]/g, '\\$&');
                var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
                results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, ' '));
            }

            function repair()
            {
                repairing = !repairing;
                if (repairing)
                {
                    selling = false;
                    document.getElementById("sell").innerHTML = "Sell";
                    document.getElementById("repair").innerHTML = "(Repair)";
                    document.getElementById("world").style.cursor = "url(repairfail.cur)";
                }
                else
                {
                    document.getElementById("repair").innerHTML = "Repair";
                    document.getElementById("world").style.cursor = "unset";
                }
            }

            function sell()
            {
                selling = !selling;
                if (selling)
                {
                    repairing = false;
                    document.getElementById("repair").innerHTML = "Repair";
                    document.getElementById("sell").innerHTML = "(Sell)";
                    document.getElementById("world").style.cursor = "url(sellfail.cur)";
                }
                else
                {
                    document.getElementById("sell").innerHTML = "Sell";
                    document.getElementById("world").style.cursor = "unset";
                }
            }

            function tileclick(x, y)
            {
                console.log("thanks for pressing " + x + " " + y + "!");
            }

            var speed = Number(getqueryparam("speed"));

            function tick()
            {
                setTimeout(tick, speed);
            }
            
            var map_request = new XMLHttpRequest();
            map_request.open("GET", getqueryparam("mapurl"), false);
            map_request.send();
            var map_doc = new DOMParser().parseFromString(map_request.response, "application/xml");
            
            var game_request = new XMLHttpRequest();
            game_request.open("GET", getqueryparam("gameurl"), false);
            game_request.send();
            var game_doc = new DOMParser().parseFromString(game_request.response, "application/xml");

            var rule_doc = new DOMParser().parseFromString(`<?xml version="1.0" encoding="UTF-8"?>
                                                            <rules>
                                                                <factions></factions>
                                                            </rules>`, "application/xml");
            function sources()
            {
                let ar = [];
                game_doc.querySelectorAll("rule").forEach(r => {
                    ar.push(r.innerHTML);
                });
                return ar;
            }
            for (const xmlStringUrl of sources())
            {
                var xmlStringRequest = new XMLHttpRequest();
                xmlStringRequest.open("GET", xmlStringUrl, false);
                xmlStringRequest.send();
                const source = new DOMParser().parseFromString(xmlStringRequest.response, 'application/xml');
                const factions = source.querySelectorAll('rules factions faction');
                if (factions.length > 0)
                {
                    factions.forEach(faction => {rule_doc.querySelector("rules factions").innerHTML += "<faction id=\"" + faction.getAttribute("id") + "\" default=\"" + faction.getAttribute("default") + "\">" + faction.innerHTML + "</faction>"});
                }
            }

            var faction = rule_doc.querySelector("rules factions faction[default=yes]").getAttribute("id");

            var cur_map = "";
            map_doc.querySelectorAll("coordinates y").forEach(function(y, yi)
            {
                cur_map += "<div class=\"row\">";
                for (let x = 0; x < y.children.length; x++)
                {
                    cur_map += "<img class=\"tile\" src=\"" + y.children[x].getAttribute("h") + "\" onclick=\"tileclick(" + x + ", " + yi + ");\">";
                }
                cur_map += "</div>";
            });
            document.getElementById("sidebar-flag").src = rule_doc.querySelector("rules factions faction[id=" + faction + "] sidebarflag").innerHTML;
            document.getElementById("loading").style = "display: none;";
            document.getElementById("world").innerHTML = cur_map;
            document.getElementById("world").style = "display: block;";
            document.getElementById("sidebar").style = "display: block;";
            tick();
        </script>
    </body>
</html>
